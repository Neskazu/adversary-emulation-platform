---
# 1. Включаем IP Forwarding
- name: Enable IPv4 forwarding (runtime)
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes

- name: Enable IPv4 forwarding (persistent)
  lineinfile:
    path: /etc/sysctl.conf
    regexp: '^net.ipv4.ip_forward='
    line: 'net.ipv4.ip_forward=1'

# 2. Настройка сетевых интерфейсов (manual)
- name: Configure network interfaces
  copy:
    dest: /etc/netplan/01-router.yaml
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          eth0:
            dhcp4: yes  
          eth1:
            dhcp4: no
            addresses: [192.168.50.1/24]
          eth2:
            dhcp4: no
            addresses: [192.168.60.1/24]
          eth3:
            dhcp4: no
            addresses: [192.168.70.1/24]
  notify: Apply netplan

# 3. Установка firewall
- name: Install iptables
  apt:
    name: iptables
    state: present
    update_cache: yes

# 4. Базовые правила firewall
- name: Flush iptables
  command: iptables -F

- name: Allow established connections
  command: iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

- name: Allow corp <-> dmz
  command: iptables -A FORWARD -s 192.168.50.0/24 -d 192.168.60.0/24 -j ACCEPT

- name: Allow corp <-> monitoring
  command: iptables -A FORWARD -s 192.168.50.0/24 -d 192.168.70.0/24 -j ACCEPT

- name: Default DROP
  command: iptables -A FORWARD -j DROP
