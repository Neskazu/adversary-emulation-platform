version: "3.8"

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s -u elastic:${ELASTIC_PASSWORD} http://localhost:9200/_cluster/health | grep -qE 'green|yellow'"
        ]
      interval: 10s
      timeout: 10s
      retries: 10
    networks:
      - elk

  setup:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: setup
    restart: "no"
    user: "0"
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - KIBANA_SYSTEM_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
      - SIGMA_USER=${SIGMA_USER}
      - SIGMA_PASSWORD=${SIGMA_PASSWORD}
    command: >
      bash -c '
        echo "Waiting for Elasticsearch...";
        until curl -s -u "elastic:$ELASTIC_PASSWORD" http://elasticsearch:9200/_cluster/health | grep -qE "green|yellow"; do
          sleep 2;
        done;

        echo "Creating Index Template for logs-*...";
        curl -s -X PUT -u "elastic:$ELASTIC_PASSWORD" \
          -H "Content-Type: application/json" \
          http://elasticsearch:9200/_index_template/logs_template \
          -d '{
            "index_patterns": ["logs-*"],
            "priority": 200,
            "template": {
              "mappings": {
                "dynamic": true,
                "properties": {
                  "source": {
                    "properties": {
                      "ip":   { "type": "ip" },
                      "port": { "type": "integer" }
                    }
                  }
                }
              }
            }
          }';

        echo "Setting kibana_system password...";
        curl -s -X POST -u "elastic:$ELASTIC_PASSWORD" \
          -H "Content-Type: application/json" \
          http://elasticsearch:9200/_security/user/kibana_system/_password \
          -d "{\"password\":\"$KIBANA_SYSTEM_PASSWORD\"}";
      '
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - elk
  sigma-init:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
    container_name: sigma-init
    restart: "no"
    user: "0"
    environment:
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
      SIGMA_USER: ${SIGMA_USER}
      SIGMA_PASSWORD: ${SIGMA_PASSWORD}
    depends_on:
      setup:
        condition: service_completed_successfully
    command: >
      bash -euo pipefail -c '
        echo "[sigma-init] waiting for security API...";
        until curl -s -u "elastic:${ELASTIC_PASSWORD}" \
          http://elasticsearch:9200/_security/_authenticate >/dev/null; do
          sleep 3;
        done;

        echo "[sigma-init] deleting old sigma user (if exists)...";
        curl -s -u "elastic:${ELASTIC_PASSWORD}" -X DELETE \
          http://elasticsearch:9200/_security/user/${SIGMA_USER} || true;

        echo "[sigma-init] creating sigma user...";
        curl -f -u "elastic:${ELASTIC_PASSWORD}" -X POST \
          http://elasticsearch:9200/_security/user/${SIGMA_USER} \
          -H "Content-Type: application/json" \
          -d "{\"password\":\"${SIGMA_PASSWORD}\",\"roles\":[\"sigma_detections_role\",\"editor\",\"kibana_admin\"]}";

        echo "[sigma-init] done";
      '
    networks:
      - elk

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.1
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
      - XPACK_SECURITY_ENABLED=true
      - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=${ENCRYPTED_SAVED_OBJECTS_KEY}
      - XPACK_REPORTING_ENCRYPTIONKEY=${ENCRYPTED_SAVED_OBJECTS_KEY}
      - XPACK_SECURITY_ENCRYPTIONKEY=${ENCRYPTED_SAVED_OBJECTS_KEY}
    depends_on:
      sigma-init:
        condition: service_completed_successfully
    networks:
      - elk

  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.1
    container_name: logstash
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - ELASTIC_USER=${ELASTIC_USER}
      - XPACK_MONITORING_ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - XPACK_MONITORING_ELASTICSEARCH_USERNAME=${ELASTIC_USER:-elastic}
      - XPACK_MONITORING_ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline
    depends_on:
      sigma-init:
        condition: service_completed_successfully
    ports:
      - "5044:5044"
      - "514:514/udp"
    networks:
      - elk

networks:
  elk:
    driver: bridge
